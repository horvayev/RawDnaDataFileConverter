using System;
using System.IO;
using System.Text;
using System.Threading.Tasks;
using DnaFormatConverter.Exceptions;
using Xunit;

namespace DnaFormatConverter.Tests
{
    public class MyHeritageV2ReaderTests
    {
        private const string TWENTY_THREE_AND_ME_SAMPLE = @"# This data file generated by 23andMe at: Thu Jul 11 21:37:24 2019
#
# This file contains raw genotype data, including data that is not used in 23andMe reports.
# This data has undergone a general quality review however only a subset of markers have been 
# individually validated for accuracy. As such, this data is suitable only for research, 
# educational, and informational use and not for medical or other use.
# 
# Below is a text version of your data.  Fields are TAB-separated
# Each line corresponds to a single SNP.  For each SNP, we provide its identifier 
# (an rsid or an internal id), its location on the reference human genome, and the 
# genotype call oriented with respect to the plus strand on the human reference sequence.
# We are using reference human assembly build 37 (also known as Annotation Release 104).
# Note that it is possible that data downloaded at different times may be different due to ongoing 
# improvements in our ability to call genotypes. More information about these changes can be found at:
# https://you.23andme.com/p/378f3bf2978d4f28/tools/data/download/
# 
# More information on reference human assembly builds:
# https://www.ncbi.nlm.nih.gov/assembly/GCF_000001405.13/
#
# rsid	chromosome	position	genotype
rs548049170	1   69869	TT
rs13328684	1   74792	--
rs4477212	1	82154	AA
rs9283150	1	565508	--
i713426	1	726912	AA
rs116587930	1	727841	GG
rs3094315	1	752566	AA
rs3131972	1	752721	GG
rs12184325	1	754105	CC
rs12567639	1	756268	AA
rs114525117	1	759036	GG
rs12124819	1	776546	--
rs12127425	1	794332	GG
rs11240777	1	798959	GG
rs6681049	1	800007	CC
rs79373928	1	801536	TT
rs72888853	1	815421	--
rs7538305	1	824398	CC
rs28444699	1	830181	AA
i713449	1	830731	--
rs116452738	1	834830	GG
rs72631887	1	835092	TT
rs4970383	1	838555	CC
rs28678693	1	838665	TT
rs4970382	1	840753	CC
rs4475691	1	846808	CC
rs72631889	1	851390	GG
rs7537756	1	854250	AA
rs13302982	1	861808	GG
rs376747791	1	863130	AA
rs2880024	1	866893	CC
rs13302914	1	868404	TT
rs76723341	1	872952	CC
rs1110052	1	873558	TT
rs2272757	1	881627	AA
rs35471880	1	881918	GG
rs2272756	1	882033	GG
rs67274836	1	884767	GG
rs3748597	1	888659	CC
rs3828049	1	889238	GG
rs77608078	1	891277	CC
rs13303106	1	891945	GG
rs28415373	1	893981	CC
rs13303010	1	894573	AA
rs13303229	1	897564	CC
rs3935066	1	900730	AA
rs6696281	1	903104	CC
rs6669800	1	903321	AA
rs28391282	1	904165	GG
rs35241590	1	904752	TT
rs28561399	1	910473	GG
rs2340592	1	910935	GG
rs3748588	1	911101	CC
rs186101910	1	914749	CC
rs41285816	1	917640	GG
rs13303118	1	918384	TT
rs2341354	1	918573	GG
rs6605059	1	919419	TT
rs4970414	1	919501	GT
rs116781904	1	919855	GG
rs61770779	1	919927	GG
rs6665000	1	924898	AA
rs2341362	1	927309	CC
rs9777703	1	928836	TT
rs1891910	1	932457	GG
rs9697457	1	934345	GG
rs35940137	1	940203	GG
rs3128117	1	944564	TT
rs2465126	1	947034	AA
rs2341365	1	948692	AA
rs15842	1	948921	CC
rs202075563	1	949472	GG
rs148041041	1	949491	GG
rs6657048	1	957640	CC
rs2799064	1	957898	GG
rs28591569	1	959509	TT
rs2710888	1	959842	CC
rs3128126	1	962210	AA
";
        private const string MY_HERITAGE_SAMPLE = "##fileformat=MyHeritage\r\n##format=MHv1.0\r\n##chip=GSA\r\n##timestamp=2019-12-22 09:09:35 UTC\r\n##reference=build37\r\n#\r\n# MyHeritage DNA raw data.\r\n# For each SNP, we provide the identifier, chromosome number, base pair position and genotype.\r\n# The genotype is reported on the forward (+) strand with respect to the human reference build 37.\r\n# THIS INFORMATION IS FOR YOUR PERSONAL USE AND IS INTENDED FOR GENEALOGICAL RESEARCH\r\n# ONLY. IT IS NOT INTENDED FOR MEDICAL OR HEALTH PURPOSES. PLEASE BE AWARE THAT THE\r\n# DOWNLOADED DATA WILL NO LONGER BE PROTECTED BY OUR SECURITY MEASURES.\r\nRSID,CHROMOSOME,POSITION,RESULT\r\n\"rs547237130\",\"1\",\"72526\",\"AA\"\r\n\"rs562180473\",\"1\",\"565703\",\"AA\"\r\n\"rs575203260\",\"1\",\"567693\",\"TT\"\r\n\"rs3131972\",\"1\",\"752721\",\"GG\"\r\n\"rs200599638\",\"1\",\"752918\",\"GG\"\r\n\"rs12184325\",\"1\",\"754105\",\"CC\"\r\n\"rs114525117\",\"1\",\"759036\",\"GG\"\r\n\"rs2980300\",\"1\",\"785989\",\"CC\"\r\n\"rs11240777\",\"1\",\"798959\",\"GG\"\r\n\"rs79373928\",\"1\",\"801536\",\"TT\"\r\n\"rs547376081\",\"1\",\"830731\",\"CC\"\r\n\"rs116452738\",\"1\",\"834830\",\"GG\"\r\n\"rs72631887\",\"1\",\"835092\",\"TT\"\r\n\"rs4970383\",\"1\",\"838555\",\"AC\"\r\n\"rs4475691\",\"1\",\"846808\",\"CC\"\r\n\"rs72631889\",\"1\",\"851390\",\"GG\"\r\n\"rs7537756\",\"1\",\"854250\",\"AG\"\r\n\"rs13302982\",\"1\",\"861808\",\"GG\"\r\n\"rs376747791\",\"1\",\"863130\",\"AA\"\r\n\"rs1110052\",\"1\",\"873558\",\"GT\"\r\n\"rs148327885\",\"1\",\"878331\",\"CC\"\r\n\"rs143853699\",\"1\",\"879911\",\"GG\"\r\n\"rs67274836\",\"1\",\"884767\",\"GG\"\r\n\"rs3748597\",\"1\",\"888659\",\"CC\"\r\n\"rs3828049\",\"1\",\"889238\",\"GG\"\r\n\"rs77608078\",\"1\",\"891277\",\"CC\"\r\n\"rs13303106\",\"1\",\"891945\",\"AG\"\r\n\"rs13303010\",\"1\",\"894573\",\"AA\"\r\n\"rs2340592\",\"1\",\"910935\",\"--\"\r\n\"rs3748588\",\"1\",\"911101\",\"CC\"\r\n\"rs186101910\",\"1\",\"914749\",\"CC\"\r\n\"rs2341354\",\"1\",\"918573\",\"AG\"\r\n\"rs61770779\",\"1\",\"919927\",\"GG\"\r\n\"rs3128117\",\"1\",\"944564\",\"TT\"\r\n\"rs2341365\",\"1\",\"948692\",\"AA\"\r\n\"rs2710888\",\"1\",\"959842\",\"CC\"\r\n\"rs3128126\",\"1\",\"962210\",\"AA\"\r\n\"rs138288952\",\"1\",\"978762\",\"GG\"\r\n\"rs144164397\",\"1\",\"978804\",\"CC\"\r\n\"rs79016973\",\"1\",\"978974\",\"GG\"\r\n\"rs143324306\",\"1\",\"979397\",\"GG\"\r\n\"rs113288277\",\"1\",\"979748\",\"AA\"\r\n\"rs112039851\",\"1\",\"980824\",\"GG\"\r\n\"rs146243145\",\"1\",\"980868\",\"GG\"\r\n\"rs142620337\",\"1\",\"983243\",\"CC\"\r\n\"rs111818381\",\"1\",\"984971\",\"GG\"\r\n\"rs145444272\",\"1\",\"986165\",\"GG\"";
        private const string MY_HERITAGE_INVALID_FORMAT_SAMPLE = "##fileformat=WRONG\r\n##format=WRONG\r\n##chip=GSA\r\n##timestamp=2019-12-22 09:09:35 UTC\r\n##reference=build37\r\n#\r\n# MyHeritage DNA raw data.\r\n# For each SNP, we provide the identifier, chromosome number, base pair position and genotype.\r\n# The genotype is reported on the forward (+) strand with respect to the human reference build 37.\r\n# THIS INFORMATION IS FOR YOUR PERSONAL USE AND IS INTENDED FOR GENEALOGICAL RESEARCH\r\n# ONLY. IT IS NOT INTENDED FOR MEDICAL OR HEALTH PURPOSES. PLEASE BE AWARE THAT THE\r\n# DOWNLOADED DATA WILL NO LONGER BE PROTECTED BY OUR SECURITY MEASURES.\r\nRSID,CHROMOSOME,POSITION,RESULT\r\n\"rs547237130\",\"1\",\"72526\",\"AA\"\r\n\"rs562180473\",\"1\",\"565703\",\"AA\"\r\n\"rs575203260\",\"1\",\"567693\",\"TT\"\r\n\"rs3131972\",\"1\",\"752721\",\"GG\"\r\n\"rs200599638\",\"1\",\"752918\",\"GG\"\r\n\"rs12184325\",\"1\",\"754105\",\"CC\"\r\n\"rs114525117\",\"1\",\"759036\",\"GG\"\r\n\"rs2980300\",\"1\",\"785989\",\"CC\"\r\n\"rs11240777\",\"1\",\"798959\",\"GG\"\r\n\"rs79373928\",\"1\",\"801536\",\"TT\"\r\n\"rs547376081\",\"1\",\"830731\",\"CC\"\r\n\"rs116452738\",\"1\",\"834830\",\"GG\"\r\n\"rs72631887\",\"1\",\"835092\",\"TT\"\r\n\"rs4970383\",\"1\",\"838555\",\"AC\"\r\n\"rs4475691\",\"1\",\"846808\",\"CC\"\r\n\"rs72631889\",\"1\",\"851390\",\"GG\"\r\n\"rs7537756\",\"1\",\"854250\",\"AG\"\r\n\"rs13302982\",\"1\",\"861808\",\"GG\"\r\n\"rs376747791\",\"1\",\"863130\",\"AA\"\r\n\"rs1110052\",\"1\",\"873558\",\"GT\"\r\n\"rs148327885\",\"1\",\"878331\",\"CC\"\r\n\"rs143853699\",\"1\",\"879911\",\"GG\"\r\n\"rs67274836\",\"1\",\"884767\",\"GG\"\r\n\"rs3748597\",\"1\",\"888659\",\"CC\"\r\n\"rs3828049\",\"1\",\"889238\",\"GG\"\r\n\"rs77608078\",\"1\",\"891277\",\"CC\"\r\n\"rs13303106\",\"1\",\"891945\",\"AG\"\r\n\"rs13303010\",\"1\",\"894573\",\"AA\"\r\n\"rs2340592\",\"1\",\"910935\",\"--\"\r\n\"rs3748588\",\"1\",\"911101\",\"CC\"\r\n\"rs186101910\",\"1\",\"914749\",\"CC\"\r\n\"rs2341354\",\"1\",\"918573\",\"AG\"\r\n\"rs61770779\",\"1\",\"919927\",\"GG\"\r\n\"rs3128117\",\"1\",\"944564\",\"TT\"\r\n\"rs2341365\",\"1\",\"948692\",\"AA\"\r\n\"rs2710888\",\"1\",\"959842\",\"CC\"\r\n\"rs3128126\",\"1\",\"962210\",\"AA\"\r\n\"rs138288952\",\"1\",\"978762\",\"GG\"\r\n\"rs144164397\",\"1\",\"978804\",\"CC\"\r\n\"rs79016973\",\"1\",\"978974\",\"GG\"\r\n\"rs143324306\",\"1\",\"979397\",\"GG\"\r\n\"rs113288277\",\"1\",\"979748\",\"AA\"\r\n\"rs112039851\",\"1\",\"980824\",\"GG\"\r\n\"rs146243145\",\"1\",\"980868\",\"GG\"\r\n\"rs142620337\",\"1\",\"983243\",\"CC\"\r\n\"rs111818381\",\"1\",\"984971\",\"GG\"\r\n\"rs145444272\",\"1\",\"986165\",\"GG\"";
        private const string MY_HERITAGE_INVALID_RECORD_SAMPLE = "##fileformat=MyHeritage\r\n##format=MHv1.0\r\n##chip=GSA\r\n##timestamp=2019-12-22 09:09:35 UTC\r\n##reference=build37\r\n#\r\n# MyHeritage DNA raw data.\r\n# For each SNP, we provide the identifier, chromosome number, base pair position and genotype.\r\n# The genotype is reported on the forward (+) strand with respect to the human reference build 37.\r\n# THIS INFORMATION IS FOR YOUR PERSONAL USE AND IS INTENDED FOR GENEALOGICAL RESEARCH\r\n# ONLY. IT IS NOT INTENDED FOR MEDICAL OR HEALTH PURPOSES. PLEASE BE AWARE THAT THE\r\n# DOWNLOADED DATA WILL NO LONGER BE PROTECTED BY OUR SECURITY MEASURES.\r\nRSID,CHROMOSOME,POSITION,RESULT\r\n\"rs547237130\",\"72526\",\"AA\"\r\n\"rs562180473\",\"1\",\"565703\",\"AA\"\r\n\"rs575203260\",\"1\",\"567693\",\"TT\"\r\n\"rs3131972\",\"1\",\"752721\",\"GG\"\r\n\"rs200599638\",\"1\",\"752918\",\"GG\"\r\n\"rs12184325\",\"1\",\"754105\",\"CC\"\r\n\"rs114525117\",\"1\",\"759036\",\"GG\"\r\n\"rs2980300\",\"1\",\"785989\",\"CC\"\r\n\"rs11240777\",\"1\",\"798959\",\"GG\"\r\n\"rs79373928\",\"1\",\"801536\",\"TT\"\r\n\"rs547376081\",\"1\",\"830731\",\"CC\"\r\n\"rs116452738\",\"1\",\"834830\",\"GG\"\r\n\"rs72631887\",\"1\",\"835092\",\"TT\"\r\n\"rs4970383\",\"1\",\"838555\",\"AC\"\r\n\"rs4475691\",\"1\",\"846808\",\"CC\"\r\n\"rs72631889\",\"1\",\"851390\",\"GG\"\r\n\"rs7537756\",\"1\",\"854250\",\"AG\"\r\n\"rs13302982\",\"1\",\"861808\",\"GG\"\r\n\"rs376747791\",\"1\",\"863130\",\"AA\"\r\n\"rs1110052\",\"1\",\"873558\",\"GT\"\r\n\"rs148327885\",\"1\",\"878331\",\"CC\"\r\n\"rs143853699\",\"1\",\"879911\",\"GG\"\r\n\"rs67274836\",\"1\",\"884767\",\"GG\"\r\n\"rs3748597\",\"1\",\"888659\",\"CC\"\r\n\"rs3828049\",\"1\",\"889238\",\"GG\"\r\n\"rs77608078\",\"1\",\"891277\",\"CC\"\r\n\"rs13303106\",\"1\",\"891945\",\"AG\"\r\n\"rs13303010\",\"1\",\"894573\",\"AA\"\r\n\"rs2340592\",\"1\",\"910935\",\"--\"\r\n\"rs3748588\",\"1\",\"911101\",\"CC\"\r\n\"rs186101910\",\"1\",\"914749\",\"CC\"\r\n\"rs2341354\",\"1\",\"918573\",\"AG\"\r\n\"rs61770779\",\"1\",\"919927\",\"GG\"\r\n\"rs3128117\",\"1\",\"944564\",\"TT\"\r\n\"rs2341365\",\"1\",\"948692\",\"AA\"\r\n\"rs2710888\",\"1\",\"959842\",\"CC\"\r\n\"rs3128126\",\"1\",\"962210\",\"AA\"\r\n\"rs138288952\",\"1\",\"978762\",\"GG\"\r\n\"rs144164397\",\"1\",\"978804\",\"CC\"\r\n\"rs79016973\",\"1\",\"978974\",\"GG\"\r\n\"rs143324306\",\"1\",\"979397\",\"GG\"\r\n\"rs113288277\",\"1\",\"979748\",\"AA\"\r\n\"rs112039851\",\"1\",\"980824\",\"GG\"\r\n\"rs146243145\",\"1\",\"980868\",\"GG\"\r\n\"rs142620337\",\"1\",\"983243\",\"CC\"\r\n\"rs111818381\",\"1\",\"984971\",\"GG\"\r\n\"rs145444272\",\"1\",\"986165\",\"GG\"";

        [Fact]
        public void Constructor_ArgumentsValidation()
        {
             Assert.Throws<ArgumentNullException>(() => new MyHeritageV2Reader(null));   
        }

        [Fact]
        public async Task Begin_InvalidFormatException() 
        {
            using (StreamReader sr = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(MY_HERITAGE_INVALID_FORMAT_SAMPLE))))
            {
                IFormatReader reader = new MyHeritageV2Reader(sr);     
                await Assert.ThrowsAsync<InvalidFormatException>(async () => await reader.Begin());                                 
            }
        }

        [Fact]
        public async Task Begin_ReadsFileToToEndOfHeader()
        {
            using (StreamReader sr = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(MY_HERITAGE_SAMPLE))))
            {
                MyHeritageV2Reader reader = new MyHeritageV2Reader(sr);     
                await reader.Begin();
                SNP snp = await reader.ReadNext();
                Assert.NotNull(snp);
                Assert.Equal("rs547237130", snp.Rsid);
            }
        }
        
        [Fact]
        public async Task ReadNext_ReadsSNPRecord()
        {
            using (StreamReader sr = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(MY_HERITAGE_SAMPLE))))
            {
                IFormatReader reader = new MyHeritageV2Reader(sr);     
                await reader.Begin();
                
                SNP snp1 = await reader.ReadNext();
                SNP snp2 = await reader.ReadNext();
                
                Assert.NotNull(snp1);
                Assert.NotNull(snp2);
                Assert.Equal("rs547237130", snp1.Rsid);
                Assert.Equal("rs562180473", snp2.Rsid);
            }
        }

        [Fact]
        public async Task ReadNext_ReturnsNull_WhenEndOfStream() 
        {
            using (StreamReader sr = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(MY_HERITAGE_SAMPLE))))
            {
                IFormatReader reader = new MyHeritageV2Reader(sr);     
                await reader.Begin();
                
                sr.ReadToEnd();

                SNP snp1 = await reader.ReadNext();
                
                Assert.Null(snp1);
            }
        }

         [Fact]
        public async Task ReadNext_Throws_WhenInvalidRecord() 
        {
            using (StreamReader sr = new StreamReader(new MemoryStream(Encoding.UTF8.GetBytes(MY_HERITAGE_INVALID_RECORD_SAMPLE))))
            {
                IFormatReader reader = new MyHeritageV2Reader(sr);     
                await reader.Begin();                
                await Assert.ThrowsAsync<InvalidFormatException>(async () => await reader.ReadNext());
            }
        }
    }
}